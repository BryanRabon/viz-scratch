

make_arc <- function(x0, y0, r, from_angle, to_angle){
  theta <- seq(from_angle, to_angle, by = 0.002)
  x_out <- x0 + r*cos(theta)
  y_out <- y0 + r*sin(theta)
  
  return(list(x = x_out, y = y_out))
}

plot_dot_map <- function(state_sp, county_sp, watermark_file){
  
  
  par(mai=c(0,0,0,0), omi=c(0,0,0,0)) #, xaxs = 'i', yaxs = 'i'
  
  plot(county_sp, col = "grey97", border = "grey70")
  plot(state_sp, col = NA, border = "black", lwd = 1.2, add = TRUE)
  add_watermark(watermark_file)
}

calc_frame_filenames <- function(frames, ...){
  cats <- c(...)
  filenames <- rep(NA_character_, (frames-1) * length(cats))
  filenames[seq(1, to = length(filenames), by = frames -1)] <- paste0(cats, "_00.png")
  cats <- c(cats, cats[1L])
  cat_i <- 1
  subframe_i <- 1
  
  for (i in 2:length(filenames)){
    if (is.na(filenames[i])){
      subframe_char <- stringr::str_pad(sprintf('%s', subframe_i), width = 2, pad = "0")
      filenames[i] <- paste(cats[cat_i], cats[cat_i+1], paste0(subframe_char, '.png'), sep = '_', collapse = "")
      subframe_i <- subframe_i + 1
    } else {
      cat_i <- cat_i + 1
      subframe_i <- 1
    }
  }
  return(filenames)
}

build_wu_gif <- function(state_sp, county_sp, dots_sp, metadata, watermark_file, gif_filename, frames = 10, ...){
  
  frame_filenames <- calc_frame_filenames(frames, ...)
  
  gifsicle_out <- c('')
  temp_dir <- tempdir()
  frame_num <- 0
  for (filename in frame_filenames){
    base_map_plot(state_sp, county_sp, metadata, watermark_file, file.path(temp_dir, filename))
    
    basefile <- strsplit(filename, '[.]')[[1]][1]
    file_pieces <- strsplit(basefile, "[_]")[[1]]
    frame <- as.numeric(tail(file_pieces, 1L)) + 1
    
    if (grepl("pie_", x = basefile)){ # case where we transition to/from pie:
      cat_to_i <- 2L
      if (grepl("_pie_",  x = basefile)){ # to pie, special case of reversing the order
        
        frame <- frames - frame + 1
        cat_to_i <- 1L
      }
      if (length(file_pieces) == 2){
        dot_to_pie(dots_sp)
        gifsicle_out <- paste0(gifsicle_out, sprintf('-d150 "#%s" ', frame_num))
      } else {
        cat_to <- file_pieces[cat_to_i]
        plot_pie_transitions(dots_sp, cat_to, frames, frame)
        gifsicle_out <- paste0(gifsicle_out, sprintf('-d10 "#%s" ', frame_num))
      }
      
    } else {
      if (length(file_pieces) == 2){
        cat <- file_pieces[1]
        dot_to_circle(dots_sp, cat = cat, col = cat_col(cat))
        gifsicle_out <- paste0(gifsicle_out, sprintf('-d150 "#%s" ', frame_num))
      } else {
        plot_dot_transitions(dots_sp, file_pieces[1], file_pieces[2], frames, frame)
        gifsicle_out <- paste0(gifsicle_out, sprintf('-d10 "#%s" ', frame_num))
      }
    }
    frame_num <- frame_num + 1
    dev.off()
    
  }
  
  system(paste0("convert -loop 0 -delay 15 ", paste(file.path(temp_dir, frame_filenames), collapse = " "), " ", gif_filename))
  
  system(sprintf('gifsicle -b %s %s --colors 256', gif_filename, gifsicle_out))
}

cat_col <- function(cat){
  cols <- c("irrigation" = "#59a14f", "industrial"="#e15759", 
            "thermoelectric"="#edc948", "publicsupply"="#76b7b2", "other"="#A9A9A9")
  cols[[cat]]
}

base_map_plot <- function(state_sp, county_sp, metadata, watermark_file, filename){
  png(filename, width = metadata[1], height = metadata[2], res=metadata[3], units = 'in')
  plot_dot_map(state_sp, county_sp, watermark_file)
}

plot_dot_transitions <- function(dots_sp, cat1, cat2, frames = 5, frame){
  
  col1 <- cat_col(cat1)
  col2 <- cat_col(cat2)
  cols <- colorRampPalette(c(col1, col2))(frames)
  interp_vals <- seq(1,0, length.out = frames)
  
  tmp_dots <- dots_sp
  tmp_dots[[cat1]] <- (interp_vals[frame]*sqrt(tmp_dots[[cat1]])+ (1 - interp_vals[frame])*sqrt(tmp_dots[[cat2]]))^2
  dot_to_circle(tmp_dots, cat1, cols[frame])
  
}

plot_pie_transitions <- function(dots_sp, cat_to, frames = 5, frame){
  
  
  interp_vals <- seq(1,0, length.out = frames)
  all_cats <- c("irrigation", "industrial", "thermoelectric", "publicsupply")
  cat_aways <- all_cats[!all_cats %in% cat_to]
  
  tmp_dots <- dots_sp
  
  total_now <- (interp_vals[frame]*sqrt(tmp_dots$total)+ (1 - interp_vals[frame])*sqrt(tmp_dots[[cat_to]]))^2
  total_diff <- dots_sp$total - (total_now - dots_sp[[cat_to]])
  
  
  tmp_dots$total <- total_now
  for (cat in cat_aways){
    orig_slice <- dots_sp$total - dots_sp[[cat_to]]
    new_slice <- total_now - dots_sp[[cat_to]]
    slice_frac <- dots_sp[[cat]]/(dots_sp$total-dots_sp[[cat_to]])
    tmp_dots[[cat]] <- dots_sp[[cat]] - (orig_slice - new_slice)*slice_frac
  }
  
  dot_to_pie(tmp_dots)
  
}

dot_to_circle <- function(dots, cat = 'total', col){
  scale_const <- 900
  transparency_alpha <- 'CC'
  for (j in seq_len(length(dots))){
    dot <- dots[j, ]
    r <- sqrt(dot[[cat]]) * scale_const
    
    circle_data <- make_arc(dot@coords[1], dot@coords[2], r, 0, 2*pi)
    polygon(circle_data$x, circle_data$y, col=paste0(col, transparency_alpha), border = col, lwd=0.75)
  }
  
}

dot_to_pie <- function(dots){
  
  scale_const <- 900
  
  categories <- c("irrigation","industrial", "thermoelectric", "publicsupply")
  
  for (j in seq_len(length(dots))){
    
    transparency_alpha <- 'CC'
    dot <- dots[j, ]
    r <- sqrt(dot$total) * scale_const
    
    c.x <- dot@coords[1]
    c.y <- dot@coords[2]
    
    #stole code from water-use-15
    for (cat in categories){
      cat_angle <- dot[[cat]] / dot[['total']]*2*pi
      if (cat == head(categories, 1L)){
        # start the first category mirror relative to the top
        angle_from <- pi/2 - cat_angle/2
        orig_ang <- angle_from
      } else {
        angle_from <- angle_to
      }
      angle_to <- angle_from + cat_angle
      if (!is.na(cat_angle) & cat_angle > 0.01){
        segments <- make_arc(c.x, c.y, r = r, angle_from, angle_to)
        polygon(c(c.x, segments$x, c.x), c(c.y, segments$y, c.y), 
                border = NA,
                col = paste0(cat_col(cat),transparency_alpha))
        lines(segments$x, segments$y, lwd=0.75, col = cat_col(cat))
      }
    }
    if (!is.na(r) & cat == tail(categories, 1L) & angle_to < 2*pi + orig_ang){
      
      segments <- make_arc(c.x, c.y, r = r, angle_to, 2*pi + orig_ang)
      polygon(c(c.x, segments$x, c.x), c(c.y, segments$y, c.y), 
              border = NA,
              col = paste0(cat_col('other'),transparency_alpha))
      lines(segments$x, segments$y, lwd=0.75, col = cat_col('other'))
    }
  }
}

add_watermark <- function(watermark_file,...){
  # --- watermark ---
  watermark_frac <- 0.2 # fraction of the width of the figure
  watermark_bump_frac <- 0.01
  coord_space <- par()$usr
  
  watermark_alpha <- 0.4
  d <- png::readPNG(watermark_file)
  
  which_image <- d[,,4] != 0 # transparency
  d[which_image] <- watermark_alpha
  
  coord_width <- coord_space[2]-coord_space[1]
  coord_height <- coord_space[4]-coord_space[3]
  watermark_width <- dim(d)[2]
  img_scale <- coord_width*watermark_frac/watermark_width
  
  x1 <- coord_space[1]+coord_width*watermark_bump_frac
  y1 <- coord_space[3]+coord_height*watermark_bump_frac
  
  rasterImage(d, x1, y1, x1+ncol(d)*img_scale, y1+nrow(d)*img_scale)
  
  text(coord_space[2], y1+coord_height*watermark_bump_frac, 'https://owi.usgs.gov/vizlab/water-use-15/', pos = 2, cex = 0.8, col = 'grey50')
}